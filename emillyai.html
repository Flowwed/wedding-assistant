<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Emily AI</title>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(180deg, #fff1f4, #ffffff);
      color: #6a2a2a;
      margin: 0;
      min-height: 100vh;

      display: flex;
      align-items: center;
      justify-content: center;
    }

    .ai-page-wrap {
      display: flex;
      align-items: stretch;
      gap: 18px;
    }

.ai-page-wrap {
  padding-left: 10px;
}


   .emily-modal {
  position: fixed;
  top: 24px;
  right: 24px;

  width: 420px;
  max-width: calc(100vw - 48px);
  height: 520px;
  max-height: calc(100vh - 48px);

  border-radius: 22px;

  box-shadow:
    0 20px 60px rgba(0,0,0,0.35),
    0 8px 24px rgba(0,0,0,0.18);

  background: #fff;
  overflow: hidden;
}

.emily-modal .ai-assistant-card {
  margin: 0;
  height: 100%;
}


    .ai-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 10px;
      margin-bottom: 10px;
      border-bottom: 1px solid #ffd6e2;
    }

    .ai-header-left {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .ai-header-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background-image: url("images/emily.jpeg");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;

      box-shadow:
        0 4px 12px rgba(180, 17, 17, 0.35),
        inset 0 0 0 2px rgba(255,255,255,0.85);

      animation: emilyBreath 4.6s ease-in-out infinite;
      transform-origin: center;
    }

    @keyframes emilyBreath {
      0%   { transform: scale(1);     box-shadow: 0 0 10px rgba(180,0,40,0.25); }
      50%  { transform: scale(1.06);  box-shadow: 0 0 20px rgba(180,0,40,0.45); }
      100% { transform: scale(1);     box-shadow: 0 0 10px rgba(180,0,40,0.25); }
    }

    .ai-voice-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .ai-voice-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: transparent;
      border: 1.5px solid rgba(180, 17, 17, 0.35);
      color: #8b1a1a;
      font-size: 14px;

      display: flex;
      align-items: center;
      justify-content: center;

      cursor: pointer;

      box-shadow: 0 2px 6px rgba(180, 17, 17, 0.15);
      transition: 0.2s ease;
    }

    .ai-voice-btn:hover {
      background: rgba(180, 17, 17, 0.06);
      box-shadow: 0 4px 10px rgba(180, 17, 17, 0.25);
    }

    .ai-voice-btn.mic-on {
      animation: micGlow 2.4s ease-in-out infinite;
    }

    @keyframes micGlow {
      0%   { box-shadow: 0 0 0 2px rgba(90,170,130,0.25), 0 0 10px rgba(90,170,130,0.35); }
      50%  { box-shadow: 0 0 0 2px rgba(90,170,130,0.45), 0 0 18px rgba(90,170,130,0.45); }
      100% { box-shadow: 0 0 0 2px rgba(90,170,130,0.25), 0 0 10px rgba(90,170,130,0.35); }
    }

    .ai-voice-btn.mic-off {
      opacity: 0.45;
      border-color: rgba(140, 0, 0, 0.45);
    }

    .listening-text {
      font-size: 13px;
      font-weight: 600;
      color: #8b1a1a;
      opacity: 0;
      transform: translateX(6px);
      transition: 0.25s ease;
      white-space: nowrap;
    }

    .listening-text.active {
      opacity: 1;
      transform: translateX(0);
    }

    .ai-messages {
      height: 220px;
      overflow-y: auto;
      padding: 6px 4px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .ai-msg {
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 14px;
      font-size: 14px;
      line-height: 1.35;
    }

    .ai-msg-bot {
      background: #fff3f6;
      border: 1px solid #ffd6e2;
      align-self: flex-start;
    }

    .ai-msg-user {
      background: #b41111;
      color: white;
      align-self: flex-end;
    }

    .ai-input-row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .ai-input-row input {
      flex: 1;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(160,0,40,0.25);
      font-size: 14px;
    }

    .ai-input-row button {
      padding: 10px 18px;
      border-radius: 12px;
      font-size: 14px;
      background: #b41111;
      color: white;
      border: none;
      font-weight: 700;
      cursor: pointer;
    }

    .ai-equalizer {
      width: 26px;
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      padding: 10px 6px;
      background: rgba(255,255,255,0.6);
      border-radius: 16px;

      box-shadow:
        0 14px 32px rgba(0,0,0,0.18),
        inset 0 0 8px rgba(255,255,255,0.55);
    }

/* bars */
.ai-equalizer span {
  display: block;
  width: 3px;
  height: 20%;
  border-radius: 3px;

  background: linear-gradient(
    to top,
    #6a0f0f,
    #b41111,
    #ffb3b3
  );

  box-shadow:
    0 0 6px rgba(180,17,17,0.6),
    inset 0 0 4px rgba(255,255,255,0.35);

  transform-origin: bottom;
  animation: eqIdle 8.2s ease-in-out infinite;
}

/* offsets */
.ai-equalizer span:nth-child(2) { animation-delay: .2s }
.ai-equalizer span:nth-child(3) { animation-delay: .4s }
.ai-equalizer span:nth-child(4) { animation-delay: .1s }
.ai-equalizer span:nth-child(5) { animation-delay: .3s }
.ai-equalizer span:nth-child(6) { animation-delay: .5s }

/* bars ‚Äî visual style only */
.ai-equalizer span {
  display: block;
  width: 3px;
  height: 20%;
  border-radius: 3px;

  background: linear-gradient(
    to top,
    #6a0f0f,
    #b41111,
    #ffb3b3
  );

  box-shadow:
    0 0 6px rgba(180,17,17,0.6),
    inset 0 0 4px rgba(255,255,255,0.35);
}

/* =============================
   AI EQUALIZER ‚Äî SMOOTH & RANDOM
============================= */

:root {
  --eq-speed: 3;
}

.ai-equalizer span {
  transform-origin: bottom;
  animation-name: eqFloat;
  animation-timing-function: cubic-bezier(.4,0,.2,1);
  animation-iteration-count: infinite;
}

/* individual timing (asynchronous) */
.ai-equalizer span:nth-child(1) {
  animation-duration: calc(3.6s * var(--eq-speed));
  animation-delay: -0.8s;
}

.ai-equalizer span:nth-child(2) {
  animation-duration: calc(4.2s * var(--eq-speed));
  animation-delay: -1.4s;
}

.ai-equalizer span:nth-child(3) {
  animation-duration: calc(3.1s * var(--eq-speed));
  animation-delay: -2.2s;
}

.ai-equalizer span:nth-child(4) {
  animation-duration: calc(4.8s * var(--eq-speed));
  animation-delay: -0.6s;
}

.ai-equalizer span:nth-child(5) {
  animation-duration: calc(3.9s * var(--eq-speed));
  animation-delay: -1.9s;
}

.ai-equalizer span:nth-child(6) {
  animation-duration: calc(4.5s * var(--eq-speed));
  animation-delay: -2.7s;
}
/* idle ‚Äî slow breathing */
@keyframes eqFloat {
  0%   { transform: scaleY(0.25); opacity: 0.6; }
  20%  { transform: scaleY(0.55); opacity: 0.8; }
  40%  { transform: scaleY(0.35); opacity: 0.7; }
  60%  { transform: scaleY(0.75); opacity: 0.9; }
  80%  { transform: scaleY(0.45); opacity: 0.75; }
  100% { transform: scaleY(0.3);  opacity: 0.6; }
}

/* speaking ‚Äî stronger but calm */
.ai-equalizer.active span {
  animation-name: eqSpeakSoft;
  opacity: 1;
}

@keyframes eqSpeakSoft {
  0%   { transform: scaleY(0.4); }
  30%  { transform: scaleY(1.1); }
  55%  { transform: scaleY(0.6); }
  75%  { transform: scaleY(0.95); }
  100% { transform: scaleY(0.45); }
}


  </style>
</head>

<body>
  <div class="ai-page-wrap">

    <div class="ai-assistant-card">
      <div class="ai-header">
        <div class="ai-header-left">
          <div class="ai-header-avatar"></div>
          <div>
            <strong>Emily</strong><br>
            <span>Wedding AI Assistant</span>
          </div>
        </div>

        <div class="ai-voice-wrapper">
          <span id="listeningText" class="listening-text">Emily is listening‚Ä¶</span>

          <button class="ai-voice-btn mic-off" id="aiVoiceBtn">üé§</button>
          <button class="ai-voice-btn" id="aiSpeakerBtn">üîä</button>
        </div>
      </div>

      <div class="ai-messages" id="aiChatBody">
        <div class="ai-msg ai-msg-bot">
          Hi, I‚Äôm Emily üëã<br>
          I‚Äôm here to help you plan your wedding.<br>
          We can start whenever you‚Äôre ready üíï
        </div>
      </div>

      <div class="ai-input-row">
        <input id="aiInput" type="text" placeholder="Ask me anything‚Ä¶" />
        <button id="aiSendBtn">Send</button>
      </div>
    </div>

    <div class="ai-equalizer">
      <span></span><span></span><span></span><span></span><span></span><span></span>
    </div>

  </div>

<script>
const aiInput = document.getElementById("aiInput");
const aiChatBody = document.getElementById("aiChatBody");
const aiSendBtn = document.getElementById("aiSendBtn");

let isEmilySpeaking = false;
let currentEmilyAudio = null;

// Send on Enter
aiInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    aiSendBtn.click();
  }
});

const params = new URLSearchParams(location.search);
const siteToken = params.get("t") || "dev";
const page = params.get("page") || "";

const AI_API =
  `https://emily-backend.onrender.com/chat` +
  `?token=${encodeURIComponent(siteToken)}` +
  `&page=${encodeURIComponent(page)}` +
  `&_=${Date.now()}`;

aiSendBtn.onclick = async () => {
  const text = aiInput.value.trim();
  if (!text) return;

  aiChatBody.innerHTML += `<div class="ai-msg ai-msg-user">${text}</div>`;
  aiInput.value = "";
  aiChatBody.scrollTop = aiChatBody.scrollHeight;

  try {
    const res = await fetch(AI_API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text })
    });

    const data = await res.json();

    aiChatBody.innerHTML += `<div class="ai-msg ai-msg-bot">${data.reply}</div>`;
    aiChatBody.scrollTop = aiChatBody.scrollHeight;

    speakEmily(data.reply);
  } catch (err) {
    aiChatBody.innerHTML += `<div class="ai-msg ai-msg-bot">‚ö†Ô∏è Sorry, I‚Äôm temporarily unavailable.</div>`;
  }
};
</script>

<script>
(() => {
  let restartTimer = null;
  let ttsActive = false;

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = new SpeechRecognition();

  recognition.lang = "en-US";
  recognition.interimResults = false;
  recognition.continuous = true;

  const voiceBtn = document.getElementById("aiVoiceBtn");
  const speakerBtn = document.getElementById("aiSpeakerBtn");
  const listeningText = document.getElementById("listeningText");

  voiceBtn.classList.add("mic-off");

  window.currentEmilyAudio = null;
  window.isEmilyMuted = false;

  const VoiceState = {
    IDLE: "IDLE",
    LISTENING: "LISTENING",
    PROCESSING: "PROCESSING",
    SPEAKING: "SPEAKING"
  };
  let voiceState = VoiceState.IDLE;

  function setVoiceState(next) {
    if (voiceState === next) return;

    try {
      switch (next) {
        case VoiceState.IDLE:
          try { recognition.stop(); } catch {}
          listeningText.classList.remove("active");
          voiceBtn.classList.remove("mic-on");
          voiceBtn.classList.add("mic-off");
          break;

        case VoiceState.LISTENING:
          try { recognition.start(); } catch {}
          listeningText.classList.add("active");
          voiceBtn.classList.add("mic-on");
          voiceBtn.classList.remove("mic-off");
          break;

        case VoiceState.PROCESSING:
          try { recognition.stop(); } catch {}
          listeningText.classList.remove("active");
          break;

        case VoiceState.SPEAKING:
          try { recognition.stop(); } catch {}
          break;
      }

      voiceState = next;
    } catch {}
  }

  recognition.onresult = (event) => {
    const text = event.results[0][0].transcript;
    aiInput.value = text;
    aiSendBtn.click();
    setVoiceState(VoiceState.PROCESSING);
  };

  voiceBtn.onclick = () => {
    if (voiceState === VoiceState.IDLE) {
      setVoiceState(VoiceState.LISTENING);
    } else {
      setVoiceState(VoiceState.IDLE);
    }
  };

  if (speakerBtn) {
    speakerBtn.addEventListener("click", () => {
      window.isEmilyMuted = !window.isEmilyMuted;

      if (window.isEmilyMuted && window.currentEmilyAudio) {
        window.currentEmilyAudio.pause();
        window.currentEmilyAudio.currentTime = 0;
        window.currentEmilyAudio = null;
      } else if (!window.isEmilyMuted && window.lastEmilyText) {
        speakEmily(window.lastEmilyText);
      }

      speakerBtn.textContent = window.isEmilyMuted ? "üîá" : "üîä";
    });
  }

  window.speakEmily = async function(text) {
    if (!text) return;
    window.lastEmilyText = text;
    if (window.isEmilyMuted) return;

    setVoiceState(VoiceState.SPEAKING);
    ttsActive = true;

    try {
      const res = await fetch("/.netlify/functions/tts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text })
      });

      const audioBlob = await res.blob();
      const audioUrl = URL.createObjectURL(audioBlob);

      if (window.currentEmilyAudio) {
        window.currentEmilyAudio.pause();
        window.currentEmilyAudio.currentTime = 0;
      }

      const audio = new Audio(audioUrl);
      window.currentEmilyAudio = audio;

      audio.onended = () => {
        URL.revokeObjectURL(audioUrl);
        window.currentEmilyAudio = null;
        ttsActive = false;
        setVoiceState(VoiceState.LISTENING);
      };

      audio.play();
    } catch (err) {
      ttsActive = false;
      setVoiceState(VoiceState.IDLE);
    }
  };
})();
</script>

<script>
  // –°–æ–æ–±—â–∞–µ–º —Ä–æ–¥–∏—Ç–µ–ª—é, —á—Ç–æ Emily –≥–æ—Ç–æ–≤–∞
  window.addEventListener("load", () => {
    if (window.parent !== window) {
      window.parent.postMessage({ type: "EMILY_READY" }, "*");
    }
  });

  // –°–ª—É—à–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è
  window.addEventListener("message", (e) => {
    if (!e.data) return;

    if (e.data.type === "EMILY_GREET" && e.data.text) {
      speakEmily(e.data.text);
    }
  });
</script>


</body>
</html>

